<!DOCTYPE html>
<meta charset='utf-8'>
<html>
  <head>
    <script src="https://d3js.org/d3.v4.min.js" charset="utf-8"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="js/underscore.js"></script>
    <script src="js/underscore.js" charset="utf-8"></script>
    <link rel='stylesheet' href='css/lineGraphAntonio.css'>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.6-rc.0/css/select2.min.css" rel="stylesheet" />
	<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.6-rc.0/js/select2.min.js"></script>
  </head>
  <body>
  	<select class="js-example-basic-multiple-2" name="movie" multiple="multiple" id="movie" style="width: 30%"></select>
  	<select class="js-example-basic-multiple" name="states[]" multiple="multiple" id='countries' style="width: 30%"></select>
  	<div id ='slopegraph'></div>
		<script>

		//INPUT TO Slopegraph
    var countries = ['USA'];
    var file_csv="/datafiles/slopegraph.csv";
    var dates =[2013,2014];
    var selectedLine;


    // CODIGO BUTOES
		$(document).ready(function() {

    		$('.js-example-basic-multiple-2').select2({
    			maximumSelectionLength: 1,
    			allowClear: true,
    			placeholder: {
					id: "-1",
					text: "Select Movie",
					selected:'selected'
				}
    		});
    		 $('.js-example-basic-multiple').select2({
  			maximumSelectionLength: 5,
  			allowClear: true,
  			 placeholder: 'Select Country'
			});
    		$('#movie').val(null).trigger('change');
    		
    		$('#countries').on('change.select2', function (e) {
  				var newCountries=$('#countries').select2('data');
  				countries=[];
  				for(var i in newCountries){
  					countries.push(newCountries[i].id);
  				} 
  				slopegraph(file_csv,countries,dates);

			});
			$('#movie').on('change.select2', function (e) {
  				var newmovie=$('#movie').select2('data');
  				if(newmovie.length !=0){
  					var date=parseInt(newmovie[0].id);
  					dates=[date-1,date+1]
  					slopegraph(file_csv,countries,dates);
  				}
  				

			});
		});
		var div = d3.select('#movie');
		d3.csv("datafiles/MovieFinal.csv", function(data) {
			// for (var i = 0; i < data.length; i++) {
			//         moviedata.push(data[i].title,year+'/'+data[i].Year});
			//     }
		
          //.on('change',variableChange)
        div.selectAll('option')  
          .data(data).enter()
        .append('option')
          .attr('value',function (d) { return d.Year})
          .text(function (d) { return d.title +' - '+ d.Year})
			
		});

		var div2 = d3.select('#countries');
		d3.csv("datafiles/countrySort.csv", function(data) {
			// for (var i = 0; i < data.length; i++) {
			//         moviedata.push(data[i].title,year+'/'+data[i].Year});
			//     }
		
          
        div2.selectAll('option')  
          .data(data).enter()
        .append('option')
          .attr('value',function (d) { return d.country})
          .text(function (d) { return d.country })
			
		});
		$(document).ready(function() {

		 $('#movie').val(null).trigger('change');
			
		});
		
		$(document).click(function (e) {
		    e.stopPropagation();
		    //check if the clicked area is dropDown or not
		  	if($(e.target)[0]==$('*')[0]){
		  		$('#movie').select2('close');
		  		$('#countries').select2('close');
		  	}
		    // if ((e.target.id != 'select2-movie-container')&&($(e.target).attr('class')!='select2-selection__arrow')&&($(e.target).attr('role')!='presentation')) {
		    //     $('#movie').select2('close');
		        
		    // }
		   	// if(((typeof $(e.target).attr('class'))=='undefined')){
		    // 		$('#countries').select2('close');
		    // 	}
		});
		

		// $(document).ready(function() {
		// 	$('#countries').val(['PRT','USA']); // Select the option with a value of '1'
		// 	$('#countries').trigger('change'); // Notify any JS components that the value changed
		// });




		//CODIGO SLOPEGRAPH

	

  function findMax(lista){
    var maxElement=lista[0];
    var index;
    var lista2=lista;
    for(var i in lista2){
      if (maxElement.value < lista2[i].value){
        maxElement=lista2[i];
        index=i;
      }
    }
    lista2.splice(index,1);
    return [maxElement,lista2];
  };
  function originalcolor(classe){
    for(var i = 0 ; i<11;i++){
        d3.selectAll('.rightlabel-'+i).transition().style('opacity', 1);
        d3.selectAll('.leftlabel-'+i).transition().style('opacity', 1);
        d3.selectAll('.line-'+i).transition().style('opacity', 1);
        d3.selectAll('.rightlabel-'+i).style('fill', 'black');
        d3.selectAll('.leftlabel-'+i).style('fill', 'black');
        d3.selectAll('.line-'+i).style('stroke', 'black');
    }
  };

	function changecolor (classe){
		if (selectedLine!=null){
			d3.selectAll('.rightlabel-'+selectedLine).style('fill', 'Black');
			d3.selectAll('.leftlabel-'+selectedLine).style('fill', 'Black');
			d3.selectAll('.line-'+selectedLine).style('stroke', 'Black');
		}
		var line = this.getAttribute('class');
		d3.selectAll('.'+line).style('stroke', 'Red');
		d3.selectAll('.'+line).transition().style('opacity', 1);
		var temp=line.split('-');
		var number=temp[1];
		selectedLine=number;
		d3.selectAll('.rightlabel-'+number).style('fill', 'Red');
		d3.selectAll('.leftlabel-'+number).style('fill', 'Red');
		d3.selectAll('.rightlabel-'+number).transition().style('opacity', 1);
		d3.selectAll('.leftlabel-'+number).transition().style('opacity', 1);
		for(var i = 0 ; i<10;i++){
			if(i!=parseInt(number)){
				d3.selectAll('.rightlabel-'+i).transition().style('opacity', 0.1);
				d3.selectAll('.leftlabel-'+i).transition().style('opacity', 0.1);
				d3.selectAll('.line-'+i).transition().style('opacity', 0.1);
			}
		}

	};

 		var margin = {top: 50, right: 0, bottom: 100, left: 30},
    	width = 550 - margin.left - margin.right,
        height = 430 - margin.top - margin.bottom,
        labelLength = 60;

    var svg = d3.select("#slopegraph").append("svg")
          .attr("width", width + margin.left + margin.right)
          .attr("height", height + margin.top + margin.bottom)
          .append("g")
          .attr("transform", "translate(" + margin.left + "," + margin.top + ")");


    var slopegraph = function(data,country,year){
    	
    	$("[class*='line-']").remove();
		$("[class*='leftlabel-']").remove();
		$("[class*='rightlabel-']").remove();
		$("#slopegraph").empty();
		svg = d3.select("#slopegraph").append("svg")
          .attr("width", width + margin.left + margin.right)
          .attr("height", height + margin.top + margin.bottom)
          .append("g")
          .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    
    	d3.csv(data, function(data) {
    	//if(error) throw error;
    	return{
      		year : +data.year,
      		country : data.country,
      		shape: data.shape,
      		value : +data.value
    };
   } ,function(error, data) {
    var filteredData1 = data.filter(function(d)
    {

        if(( country.includes(d["country"])) && (d["year"] == year[0]))
        {
            return d;
        }

    })
    var filteredData2 = data.filter(function(d)
    {

        if(( country.includes(d["country"])) && (d["year"] == year[1]))
        {
            return d;
        }

    })

            ////////DATAGROUPER DECLARATION - BEGIN
            var DataGrouper = (function() {
                var has = function(obj, target) {
                    return _.any(obj, function(value) {
                        return _.isEqual(value, target);
                    });
                };

                var keys = function(data, names) {
                    return _.reduce(data, function(memo, item) {
                        var key = _.pick(item, names);
                        if (!has(memo, key)) {
                            memo.push(key);
                        }
                        return memo;
                    }, []);
                };

                var group = function(data, names) {
                    var stems = keys(data, names);
                    return _.map(stems, function(stem) {
                        return {
                            key: stem,
                            vals:_.map(_.where(data, stem), function(item) {
                                return _.omit(item, names);
                            })
                        };
                    });
                };

                group.register = function(name, converter) {
                    return group[name] = function(data, names) {
                        return _.map(group(data, names), converter);
                    };
                };

                return group;
            }());
            DataGrouper.register("sum", function(item) {
                return _.extend({}, item.key, {value: _.reduce(item.vals, function(memo, node) {
                    return memo + Number(node.value);
                }, 0)});
            });
            ////////DATAGROUPER DECLARATION - END
    filteredData1 = DataGrouper.sum(filteredData1,["shape"]);
    filteredData2 = DataGrouper.sum(filteredData2,["shape"]);
    if ((filteredData1.length==0)&&(filteredData2.length==0)){
      svg.append('text').text('NO SIGHTINGS REPORTED IN ' + dates + ' IN ' + countries);
      return; 
    }
    else if((filteredData1.length==0)){
      svg.append('text').text('NO SIGHTINGS REPORTED IN ' + dates[0] + ' IN ' + countries);
      return; 
    }
    else if((filteredData2.length==0)){
      svg.append('text').text('NO SIGHTINGS REPORTED IN ' + dates[1] + ' IN ' + countries);
      return; 
    }
    var finalfilteredData1=[];
    var finalfilteredData2=[];
    var temp = JSON.parse(JSON.stringify(filteredData1));
    var maxtopleft=5;
    if(filteredData1.length<5){
      maxtopleft=filteredData1.length;
    }
    var maxtopright=5;
    if(filteredData2.length<5){
      maxtopright=filteredData2.length;
    }
    for(var i = 0; i<maxtopleft;i++){
      var aux= findMax(temp);
      finalfilteredData1.push(aux[0]);
      temp=aux[1];
    }
    var temp = JSON.parse(JSON.stringify(filteredData2));
    for(var i = 0; i<maxtopright;i++){
      var aux= findMax(temp);
      finalfilteredData2.push(aux[0]);
      temp=aux[1];
    }
    var present =0;
    for(var i in finalfilteredData1){
      for(var j in finalfilteredData2){
        if(finalfilteredData1[i].shape==finalfilteredData2[j].shape)
          present=1;
      }
      if(present==0){
        finalfilteredData2.push(finalfilteredData1[i]);
      }
      present=0;
    }
    var present =0;
    for(var i in finalfilteredData2){
      for(var j in finalfilteredData1){
        if(finalfilteredData2[i].shape==finalfilteredData1[j].shape)
          present=1;
      }
      if(present==0){
        finalfilteredData1.push(finalfilteredData2[i]);
      }
      present=0;
    }
    filteredData1=finalfilteredData1;
    filteredData2=finalfilteredData2;

    

   // concatenate the two table by the shape key;
   var values1=[];
   var values2=[];
    for (i in filteredData1){
    	values1.push(filteredData1[i].value)
    	for(k in filteredData2){
    		if(filteredData1[i].shape==filteredData2[k].shape){
    			filteredData1[i]['value2']=filteredData2[k].value;
    			values2.push(filteredData2[k].value);
    			break;
    		}
    	}
    }
    var textdataleft = JSON.parse(JSON.stringify(values1));
    var textdataright = JSON.parse(JSON.stringify(values2));
    //textdataleft=textdataleft.sort(function(a, b){return a-b});
    //textdataright=textdataright.sort(function(a, b){return a-b});
    var notchanged=true;
    var aux_i;
    var aux_k;

    var filteredDataAll=filteredData1.concat(filteredData2);
    var maxValue = d3.max(filteredDataAll, function (d) { return d.value; } );
    var minValue = d3.min(filteredDataAll, function (d) { return d.value; } );

	var yScale = d3.scaleLinear()
    .domain([minValue, maxValue])
    .range([height,20]);
   
    // while(notchanged){
    //   notchanged=false;

    //   for(var i=0; i<textdataright.length;i++){
    //     for(var k=0; k<textdataright.length;k++){
    //     	console.log(yScale(textdataright[i])- yScale(textdataright[k]));
    //       if (i !=k){
    //         if((yScale(textdataright[i])- yScale(textdataright[k])>=0) && (textdataright[i] - textdataright[k]>=0) && notchanged==false){
    //      		textdataright[i]=textdataright[i]+40;
    //           	notchanged=true;
    //           	break;
    //         }
    //       }
    //     }
        
    //   }
    // } 

    // var notchanged=true;
    // while(notchanged){
    //   notchanged=false;
    //   for(var i=0; i<textdataleft.length;i++){
    //     for(var k=0; k<textdataleft.length;k++){
    //       if (i !=k){
    //         if((yScale(textdataleft[i] - textdataleft[k])<=10) && (textdataleft[i] - textdataleft[k]>=0) && notchanged==false){
   	// 			textdataleft[i]=textdataleft[i]+15;
    //           notchanged=true;
    //         }
    //       }
    //     }
        
    //   }
    // } 



    
    //var scale = d3.scaleLinear().domain(d3.extent(filteredDataAll, function(d) { return d.value;})).range([0,height]);
    // var xScale = d3.scaleLinear()
    // .domain([0, 15])
    // .range([0, width]);
    
   // var scale = d3.scaleLinear().domain(d3.extent(d3.merge(data))).range([0, height]);
   
	for (var i =0; i<values1.length;i++){ 
	   svg.append('line')
	    .style('stroke', 'black')
	    .attr('x1', margin.left + labelLength)
	    .attr('y1', yScale(values1[i]))
	    .attr('x2', width - margin.right - labelLength)
	    .attr('y2', yScale(values2[i]))
	    .attr('class','line-'+i)
	    .on("mouseover", changecolor)
      .on("mouseleave", originalcolor);
	}

	// LEFT LABEL
	
	for (var i =0; i<values1.length;i++){
	    svg.append('text')
	    	.attr('x',margin.left)
	    	.attr('y',yScale(values1[i]))
	    	.text(filteredData1[i].shape)
	    	.attr('class', 'leftlabel-' + i);
	}
	// RIGTH LABEL
	for (var i =0; i<values2.length;i++){
	    svg.append('text')
	    	.attr('x',width - margin.right-labelLength)
	    	.attr('y',yScale(values2[i]))
	    	.text(filteredData1[i].shape)
	    	.attr('class', 'rightlabel-' + i)
	    	
	}

	//TOP LEFT LABEL
		svg.append('text')
	    	.attr('x',margin.left)
	    	.attr('y',0)
	    	.text(dates[0])
	    	.attr('class', 'leftlabel-top-label');
	//TOP RIGHT LABEL
		svg.append('text')
	    	.attr('x',width - margin.right-labelLength)
	    	.attr('y',0)
	    	.text(dates[1])
	    	.attr('class', 'rightlabel-top-label');
    }

   )};

   slopegraph(file_csv,countries,dates)
		
		</script>
  </body>
</html>